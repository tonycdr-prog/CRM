// server/pdf/inspectionPdf.ts
import PDFDocument from "pdfkit";
import fs from "fs";

export type PdfAttachment = {
  originalName: string;
  mimeType?: string | null;
  // For local storage: absolute path to file on disk
  localPath?: string | null;
};

export type PdfRow = {
  component: string;
  activity: string;
  reference?: string | null;
  fieldType: string;
  units?: string | null;
  evidenceRequired: boolean;
  value: string;
  comment?: string | null;
  attachments: PdfAttachment[];
};

export type PdfEntity = {
  title: string;
  description?: string | null;
  rows: PdfRow[];
};

export type PdfPayload = {
  inspectionId: string;
  templateName: string;
  systemTypeName: string;
  jobId: string;
  completedAt: string;
  entities: PdfEntity[];
};

function drawKeyValue(doc: PDFKit.PDFDocument, label: string, value: string) {
  doc.font("Helvetica-Bold").text(label, { continued: true });
  doc.font("Helvetica").text(` ${value}`);
}

function isImageMime(m?: string | null) {
  return !!m && (m.startsWith("image/jpeg") || m.startsWith("image/png") || m.startsWith("image/webp"));
}

function safeExists(p?: string | null) {
  try {
    return !!p && fs.existsSync(p);
  } catch {
    return false;
  }
}

function ensureSpace(doc: PDFKit.PDFDocument, neededHeight: number) {
  const bottom = doc.page.height - doc.page.margins.bottom;
  if (doc.y + neededHeight > bottom) doc.addPage();
}

export function buildInspectionPdf(payload: PdfPayload) {
  const doc = new PDFDocument({
    size: "A4",
    margins: { top: 50, left: 50, right: 50, bottom: 50 },
    info: {
      Title: `Inspection ${payload.inspectionId}`,
      Author: "Life Safety OPS",
    },
  });

  doc.fontSize(18).font("Helvetica-Bold").text("Inspection Report");
  doc.moveDown(0.8);

  doc.fontSize(11).font("Helvetica");
  drawKeyValue(doc, "Job ID:", payload.jobId);
  drawKeyValue(doc, "System:", payload.systemTypeName);
  drawKeyValue(doc, "Template:", payload.templateName);
  drawKeyValue(doc, "Completed:", new Date(payload.completedAt).toISOString());
  drawKeyValue(doc, "Inspection ID:", payload.inspectionId);

  doc.moveDown(1.0);
  doc.moveTo(doc.page.margins.left, doc.y)
    .lineTo(doc.page.width - doc.page.margins.right, doc.y)
    .stroke();
  doc.moveDown(0.8);

  const maxThumbsPerRow = 2; // keep PDFs reasonable
  const thumbMaxWidth = 220;
  const thumbMaxHeight = 140;

  for (const entity of payload.entities) {
    ensureSpace(doc, 80);
    doc.fontSize(14).font("Helvetica-Bold").text(entity.title);
    if (entity.description) {
      doc.fontSize(10).font("Helvetica").fillColor("gray").text(entity.description);
      doc.fillColor("black");
    }
    doc.moveDown(0.4);

    for (const row of entity.rows) {
      ensureSpace(doc, 140);

      doc.fontSize(11).font("Helvetica-Bold").text(`${row.component} — ${row.activity}`);
      doc.fontSize(10).font("Helvetica").fillColor("gray");
      const metaParts: string[] = [];
      if (row.reference) metaParts.push(`Ref: ${row.reference}`);
      metaParts.push(`Type: ${row.fieldType}`);
      if (row.units) metaParts.push(`Units: ${row.units}`);
      if (row.evidenceRequired) metaParts.push(`Evidence required`);
      doc.text(metaParts.join(" • "));
      doc.fillColor("black");

      doc.fontSize(11).font("Helvetica").text(`Result: ${row.value || "—"}`);

      if (row.comment) {
        doc.fontSize(10).fillColor("gray").text(`Comment: ${row.comment}`);
        doc.fillColor("black");
      }

      // Attachments: list non-images, embed thumbnails for images
      const images = row.attachments.filter((a) => isImageMime(a.mimeType) && safeExists(a.localPath));
      const nonImages = row.attachments.filter((a) => !isImageMime(a.mimeType));

      if (nonImages.length) {
        doc.fontSize(10).fillColor("gray").text(
          `Attachments: ${nonImages.map((a) => a.originalName).join(", ")}`
        );
        doc.fillColor("black");
      }

      const imgsToRender = images.slice(0, maxThumbsPerRow);
      if (imgsToRender.length) {
        doc.moveDown(0.2);
        doc.fontSize(10).fillColor("gray").text("Evidence thumbnails:");
        doc.fillColor("black");

        for (const img of imgsToRender) {
          ensureSpace(doc, thumbMaxHeight + 50);

          // caption
          doc.fontSize(9).fillColor("gray").text(img.originalName);
          doc.fillColor("black");

          const x = doc.page.margins.left;
          const y = doc.y + 4;

          try {
            doc.image(img.localPath as string, x, y, {
              fit: [thumbMaxWidth, thumbMaxHeight],
              align: "left",
              valign: "top",
            });
            doc.y = y + thumbMaxHeight + 6;
          } catch {
            doc.fontSize(10).fillColor("gray").text("(Unable to render image)");
            doc.fillColor("black");
            doc.moveDown(0.5);
          }
        }

        if (images.length > maxThumbsPerRow) {
          doc.fontSize(9).fillColor("gray").text(`(+${images.length - maxThumbsPerRow} more image(s) not shown)`);
          doc.fillColor("black");
        }
      }

      doc.moveDown(0.6);
      // separator
      ensureSpace(doc, 20);
      doc
        .moveTo(doc.page.margins.left, doc.y)
        .lineTo(doc.page.width - doc.page.margins.right, doc.y)
        .strokeColor("#eeeeee")
        .stroke()
        .strokeColor("black");
      doc.moveDown(0.6);
    }

    doc.moveDown(0.8);
  }

  return doc;
}